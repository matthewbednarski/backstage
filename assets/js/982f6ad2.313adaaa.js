/*! For license information please see 982f6ad2.313adaaa.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[871585],{979800:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>o,contentTitle:()=>i,default:()=>h,frontMatter:()=>s,metadata:()=>c,toc:()=>d});var t=a(474848),r=a(28453);const s={id:"url-reader",title:"URL Reader",sidebar_label:"URL Reader",description:"URL Reader is a backend core API responsible for reading files from external locations."},i=void 0,c={id:"plugins/url-reader",title:"URL Reader",description:"URL Reader is a backend core API responsible for reading files from external locations.",source:"@site/versioned_docs/version-stable/plugins/url-reader.md",sourceDirName:"plugins",slug:"/plugins/url-reader",permalink:"/docs/plugins/url-reader",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/plugins/url-reader.md",tags:[],version:"stable",frontMatter:{id:"url-reader",title:"URL Reader",sidebar_label:"URL Reader",description:"URL Reader is a backend core API responsible for reading files from external locations."},sidebar:"docs",previous:{title:"Call Existing API",permalink:"/docs/plugins/call-existing-api"},next:{title:"Testing with Jest",permalink:"/docs/plugins/testing"}},o={},d=[{value:"Concept",id:"concept",level:2},{value:"Interface",id:"interface",level:2},{value:"Using a URL Reader inside a plugin",id:"using-a-url-reader-inside-a-plugin",level:2},{value:"Writing a new URL Reader",id:"writing-a-new-url-reader",level:2},{value:"1. Add an integration",id:"1-add-an-integration",level:3},{value:"2. Create the URL Reader",id:"2-create-the-url-reader",level:3},{value:"3. Implement the methods",id:"3-implement-the-methods",level:3},{value:"<code>readUrl</code>",id:"readurl",level:4},{value:"<code>readTree</code>",id:"readtree",level:4},{value:"search",id:"search",level:4},{value:"4. Add to available URL Readers",id:"4-add-to-available-url-readers",level:3},{value:"5. Caching",id:"5-caching",level:3},{value:"6. Debugging",id:"6-debugging",level:3}];function l(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"concept",children:"Concept"}),"\n",(0,t.jsxs)(n.p,{children:["Some of the core plugins of Backstage have to read files from an external\nlocation. ",(0,t.jsx)(n.a,{href:"/docs/features/software-catalog/",children:"Software Catalog"})," has to read\nthe ",(0,t.jsx)(n.a,{href:"/docs/features/software-catalog/descriptor-format",children:(0,t.jsx)(n.code,{children:"catalog-info.yaml"})}),"\nentity descriptor files to register and track an entity.\n",(0,t.jsx)(n.a,{href:"/docs/features/software-templates/",children:"Software Templates"})," have to download\nthe template skeleton files before creating a new component.\n",(0,t.jsx)(n.a,{href:"/docs/features/techdocs/",children:"TechDocs"})," has to download the markdown source\nfiles before generating a documentation site."]}),"\n",(0,t.jsxs)(n.p,{children:["Since, the requirement for reading files is so essential for Backstage plugins,\nthe\n",(0,t.jsx)(n.a,{href:"/docs/reference/backend-plugin-api.coreservices.urlreader",children:(0,t.jsx)(n.code,{children:"coreServices.urlReader"})}),'\npackage provides a dedicated API for reading from such URL based remote\nlocations like GitHub, GitLab, Bitbucket, Google Cloud Storage, etc. This is\ncommonly referred to as "URL Reader". It takes care of making authenticated\nrequests to the remote host so that private files can be read securely. If users\nhave ',(0,t.jsx)(n.a,{href:"/docs/integrations/github/github-apps",children:"GitHub App based authentication"})," set up, URL Reader even\nrefreshes the token, to avoid reaching the GitHub API rate limit."]}),"\n",(0,t.jsx)(n.p,{children:"As a result, plugin authors do not have to worry about any of these problems\nwhen trying to read files."}),"\n",(0,t.jsx)(n.h2,{id:"interface",children:"Interface"}),"\n",(0,t.jsxs)(n.p,{children:["When the Backstage backend starts, a new instance of URL Reader is created. You\ncan see this in the index file of your Backstage backend\ni.e.",(0,t.jsx)(n.code,{children:"packages/backend/src/index.ts"}),".\n",(0,t.jsx)(n.a,{href:"https://github.com/backstage/backstage/blob/ebbe91dbe79038a61d35cf6ed2d96e0e0d5a15f3/packages/backend/src/index.ts#L57",children:"Example"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"// File: packages/backend/src/index.ts\n\nimport { UrlReaders } from '@backstage/backend-common';\n\nfunction makeCreateEnv(config: Config) {\n  // ....\n  const reader = UrlReaders.default({ logger: root, config });\n  //\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"This instance contains all the default URL Reader providers\nin the backend-defaults package including GitHub, GitLab, Bitbucket, Azure, Google\nGCS. As the need arises, more URL Readers are being written to support different\nproviders."}),"\n",(0,t.jsx)(n.p,{children:"The generic interface of a URL Reader instance looks like this."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"export type UrlReader = {\n  /* Used to read a single file and return its content. */\n  readUrl(url: string, options?: ReadUrlOptions): Promise<ReadUrlResponse>;\n  /* Used to read a file tree and download as a directory. */\n  readTree(url: string, options?: ReadTreeOptions): Promise<ReadTreeResponse>;\n  /* Used to search a file in a tree. */\n  search(url: string, options?: SearchOptions): Promise<SearchResponse>;\n};\n"})}),"\n",(0,t.jsx)(n.h2,{id:"using-a-url-reader-inside-a-plugin",children:"Using a URL Reader inside a plugin"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"reader"})," instance is available in the backend plugin environment and passed\non to all the backend plugins. You can see an\n",(0,t.jsx)(n.a,{href:"https://github.com/backstage/backstage/blob/b0be185369ebaad22255b7cdf18535d1d4ffd0e7/packages/backend/src/plugins/techdocs.ts#L31",children:"example"}),".\nWhen any of the methods on this instance is called with a URL, URL Reader\nextracts the host for that URL (e.g. ",(0,t.jsx)(n.code,{children:"github.com"}),", ",(0,t.jsx)(n.code,{children:"ghe.mycompany.com"}),", etc.).\nUsing the\n",(0,t.jsx)(n.a,{href:"https://github.com/backstage/backstage/tree/master/packages/integration",children:(0,t.jsx)(n.code,{children:"@backstage/integration"})}),"\npackage, it looks inside the\n",(0,t.jsx)(n.a,{href:"https://github.com/backstage/backstage/blob/d5c83bb889b8142e343ebc4e4c0b90a02d1c1a3d/app-config.yaml#L134-L158",children:(0,t.jsx)(n.code,{children:"integrations:"})}),"\nconfig of the ",(0,t.jsx)(n.code,{children:"app-config.yaml"})," to find out how to work with the host based on\nthe configs provided like authentication token, API base URL, etc."]}),"\n",(0,t.jsxs)(n.p,{children:["Make sure your plugin-specific backend file at\n",(0,t.jsx)(n.code,{children:"packages/backend/src/plugins/<PLUGIN>.ts"})," is forwarding the ",(0,t.jsx)(n.code,{children:"reader"})," instance\npassed on as the ",(0,t.jsx)(n.code,{children:"PluginEnvironment"})," to the actual plugin's ",(0,t.jsx)(n.code,{children:"createRouter"}),"\nfunction. See how this is done in\n",(0,t.jsx)(n.a,{href:"https://github.com/backstage/backstage/blob/d5c83bb889b8142e343ebc4e4c0b90a02d1c1a3d/packages/backend/src/plugins/catalog.ts#L25-L27",children:"Catalog"}),"\nand\n",(0,t.jsx)(n.a,{href:"https://github.com/backstage/backstage/blob/d5c83bb889b8142e343ebc4e4c0b90a02d1c1a3d/packages/backend/src/plugins/techdocs.ts#L31-L36",children:"TechDocs"}),"\nbackend plugins."]}),"\n",(0,t.jsx)(n.p,{children:"Once the reader instance is available inside the plugin, one of its methods can\ndirectly be used with a URL. Some example usages -"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/backstage/backstage/blob/a7607b5/plugins/catalog-backend/src/modules/codeowners/lib/read.ts#L24-L33",children:(0,t.jsx)(n.code,{children:"readUrl"})})," -\nCatalog using the ",(0,t.jsx)(n.code,{children:"readUrl"})," method to read the CODEOWNERS file in a repository."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/backstage/backstage/blob/84a8788/plugins/techdocs-node/src/helpers.ts#L146-L167",children:(0,t.jsx)(n.code,{children:"readTree"})})," -\nTechDocs using the ",(0,t.jsx)(n.code,{children:"readTree"})," method to download markdown files in order to\ngenerate the documentation site."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/backstage/backstage/blob/cb4f0e4/plugins/techdocs-node/src/stages/prepare/url.ts#L51-L73",children:(0,t.jsx)(n.code,{children:"readTree"})})," -\nTechDocs using ",(0,t.jsx)(n.code,{children:"NotModifiedError"})," to maintain cache and speed up and limit the\nnumber of requests."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/backstage/backstage/blob/d5c83bb889b8142e343ebc4e4c0b90a02d1c1a3d/plugins/catalog-backend/src/ingestion/processors/UrlReaderProcessor.ts#L88-L108",children:(0,t.jsx)(n.code,{children:"search"})})," -\nCatalog using the ",(0,t.jsx)(n.code,{children:"search"})," method to find files for a location URL containing\na glob pattern."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Note that URL Readers which target git-based version control systems may, under\nthe hood, leverage the ability to create tar archives based on a specific git\ncommit-ish. A consequence of this is that files and directories configured with\n",(0,t.jsxs)(n.a,{href:"https://git-scm.com/docs/gitattributes#_creating_an_archive",children:["the ",(0,t.jsx)(n.code,{children:"export-ignore"})," attribute"]}),"\nvia ",(0,t.jsx)(n.code,{children:".gitattributes"})," will not be visible to the URL reader when using the\n",(0,t.jsx)(n.code,{children:"readTree"})," or ",(0,t.jsx)(n.code,{children:"search"})," methods."]}),"\n",(0,t.jsx)(n.p,{children:"Be aware of this limitation and ensure that end-users of your plugin are also\naware via, for example, documentation."}),"\n",(0,t.jsx)(n.h2,{id:"writing-a-new-url-reader",children:"Writing a new URL Reader"}),"\n",(0,t.jsx)(n.p,{children:"If the available URL Readers are not sufficient for your use case and you want\nto add a new URL Reader for any other provider, you are most welcome to\ncontribute one!"}),"\n",(0,t.jsxs)(n.p,{children:["Feel free to use the\n",(0,t.jsx)(n.a,{href:"https://github.com/backstage/backstage/blob/d5c83bb889b8142e343ebc4e4c0b90a02d1c1a3d/packages/backend-common/src/reading/GithubUrlReader.ts",children:"GitHub URL Reader"}),"\nas a source of inspiration."]}),"\n",(0,t.jsx)(n.h3,{id:"1-add-an-integration",children:"1. Add an integration"}),"\n",(0,t.jsxs)(n.p,{children:['The provider for your new URL Reader can also be called an "integration" in\nBackstage. The ',(0,t.jsx)(n.code,{children:"integrations:"})," section of your Backstage ",(0,t.jsx)(n.code,{children:"app-config.yaml"}),"\nconfig file is supposed to be the place where a Backstage integrator defines the\nhost URL for the integration, authentication details and other integration\nrelated configurations."]}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"@backstage/integration"}),' package is where most of the integration specific\ncode lives, so that it is shareable across Backstage. Functions like "read the\nintegrations config and process it", "construct headers for authenticated\nrequests to the host" or "convert a plain file URL into its API URL for\ndownloading the file" would live in this package.']}),"\n",(0,t.jsx)(n.h3,{id:"2-create-the-url-reader",children:"2. Create the URL Reader"}),"\n",(0,t.jsxs)(n.p,{children:["Create a new class which implements the\n",(0,t.jsxs)(n.a,{href:"https://github.com/backstage/backstage/blob/d5c83bb889b8142e343ebc4e4c0b90a02d1c1a3d/packages/backend-common/src/reading/types.ts#L21-L28",children:[(0,t.jsx)(n.code,{children:"UrlReader"})," type"]}),"\ninside ",(0,t.jsx)(n.code,{children:"@backstage/backend-common"}),". Create and export a static ",(0,t.jsx)(n.code,{children:"factory"})," method\nwhich reads the integration config and returns a map of host URLs the new reader\nshould be used for. See the\n",(0,t.jsx)(n.a,{href:"https://github.com/backstage/backstage/blob/d5c83bb889b8142e343ebc4e4c0b90a02d1c1a3d/packages/backend-common/src/reading/GithubUrlReader.ts#L50-L63",children:"GitHub URL Reader"}),"\nfor example."]}),"\n",(0,t.jsx)(n.h3,{id:"3-implement-the-methods",children:"3. Implement the methods"}),"\n",(0,t.jsxs)(n.p,{children:["We want to make sure all URL Readers behave in the same way. Hence if possible,\nall the methods of the ",(0,t.jsx)(n.code,{children:"UrlReader"})," interface should be implemented. However it\nis okay to start by implementing just one of them and create issues for the\nremaining."]}),"\n",(0,t.jsx)(n.h4,{id:"readurl",children:(0,t.jsx)(n.code,{children:"readUrl"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"readUrl"})," method expects a user-friendly URL, something which can be copied from\nthe browser naturally when a person is browsing the provider in their browser."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u2705 Valid URL :\n",(0,t.jsx)(n.code,{children:"https://github.com/backstage/backstage/blob/master/ADOPTERS.md"})]}),"\n",(0,t.jsxs)(n.li,{children:["\u274c Not a valid URL :\n",(0,t.jsx)(n.code,{children:"https://raw.githubusercontent.com/backstage/backstage/master/ADOPTERS.md"})]}),"\n",(0,t.jsxs)(n.li,{children:["\u274c Not a valid URL : ",(0,t.jsx)(n.code,{children:"https://github.com/backstage/backstage/ADOPTERS.md"})]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Upon receiving the URL, ",(0,t.jsx)(n.code,{children:"readUrl"})," converts the user-friendly URL into an API URL\nwhich can be used to request the provider's API."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"readUrl"})," then makes an authenticated request to the provider API and returns the response containing the file's contents and ETag(if the provider supports it)."]}),"\n",(0,t.jsx)(n.h4,{id:"readtree",children:(0,t.jsx)(n.code,{children:"readTree"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"readTree"})," method also expects user-friendly URLs similar to ",(0,t.jsx)(n.code,{children:"read"})," but the URL\nshould point to a tree (could be the root of a repository or even a\nsub-directory)."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u2705 Valid URL : ",(0,t.jsx)(n.code,{children:"https://github.com/backstage/backstage"})]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 Valid URL : ",(0,t.jsx)(n.code,{children:"https://github.com/backstage/backstage/blob/master"})]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 Valid URL : ",(0,t.jsx)(n.code,{children:"https://github.com/backstage/backstage/blob/master/docs"})]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Using the provider's API documentation, find out an API endpoint which can be\nused to download either a zip or a tarball. You can download the entire tree\n(e.g. a repository) and filter out in case the user is expecting only a\nsub-tree. But some APIs are smart enough to accept a path and return only a\nsub-tree in the downloaded archive."}),"\n",(0,t.jsx)(n.h4,{id:"search",children:"search"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"search"})," method expects a glob pattern of a URL and returns a list of files\nmatching the query."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u2705 Valid URL :\n",(0,t.jsx)(n.code,{children:"https://github.com/backstage/backstage/blob/master/**/catalog-info.yaml"})]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 Valid URL : ",(0,t.jsx)(n.code,{children:"https://github.com/backstage/backstage/blob/master/**/*.md"})]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 Valid URL :\n",(0,t.jsx)(n.code,{children:"https://github.com/backstage/backstage/blob/master/*/package.json"})]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 Valid URL : ",(0,t.jsx)(n.code,{children:"https://github.com/backstage/backstage/blob/master/READM"})]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["The core logic of ",(0,t.jsx)(n.code,{children:"readTree"})," can be used here to extract all the files inside\nthe tree and return the files matching the pattern in the ",(0,t.jsx)(n.code,{children:"url"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"4-add-to-available-url-readers",children:"4. Add to available URL Readers"}),"\n",(0,t.jsx)(n.p,{children:"There are two ways to make your new URL Reader available for use."}),"\n",(0,t.jsxs)(n.p,{children:["You can choose to make it open source, by updating the\n",(0,t.jsxs)(n.a,{href:"https://github.com/backstage/backstage/blob/d5c83bb889b8142e343ebc4e4c0b90a02d1c1a3d/packages/backend-common/src/reading/UrlReaders.ts#L62-L81",children:[(0,t.jsx)(n.code,{children:"default"})," factory"]}),"\nmethod of URL Readers."]}),"\n",(0,t.jsxs)(n.p,{children:["But for something internal which you don't want to make open source, you can\nupdate your ",(0,t.jsx)(n.code,{children:"packages/backend/src/index.ts"})," file and update how the ",(0,t.jsx)(n.code,{children:"reader"}),"\ninstance is created."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"// File: packages/backend/src/index.ts\nconst reader = UrlReaders.default({\n  logger: root,\n  config,\n  // This is where your internal URL Readers would go.\n  factories: [myCustomReader.factory],\n});\n"})}),"\n",(0,t.jsx)(n.h3,{id:"5-caching",children:"5. Caching"}),"\n",(0,t.jsxs)(n.p,{children:["All of the methods above support an ETag based caching. If the method is called\nwithout an ",(0,t.jsx)(n.code,{children:"etag"}),", the response contains an ETag of the resource (should ideally\nforward the ETag returned by the provider). If the method is called with an\n",(0,t.jsx)(n.code,{children:"etag"}),", it first compares the ETag and returns a ",(0,t.jsx)(n.code,{children:"NotModifiedError"})," in case the\nresource has not been modified. This approach is very similar to the actual\n",(0,t.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag",children:(0,t.jsx)(n.code,{children:"ETag"})})," and\n",(0,t.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/If-None-Match",children:(0,t.jsx)(n.code,{children:"If-None-Match"})}),"\nHTTP headers."]}),"\n",(0,t.jsx)(n.h3,{id:"6-debugging",children:"6. Debugging"}),"\n",(0,t.jsxs)(n.p,{children:["When debugging one of the URL Readers, you can straightforward use the\n",(0,t.jsxs)(n.a,{href:"https://github.com/backstage/backstage/blob/ebbe91dbe79038a61d35cf6ed2d96e0e0d5a15f3/packages/backend/src/index.ts#L57",children:[(0,t.jsx)(n.code,{children:"reader"})," instance created"]}),"\nwhen the backend starts and call one of the methods with your debugging URL."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"// File: packages/backend/src/index.ts\n\nasync function main() {\n  // ...\n  const createEnv = makeCreateEnv(config);\n\n  const testReader = createEnv('test-url-reader').reader;\n  const response = await testReader.readUrl(\n    'https://github.com/backstage/backstage/blob/master/catalog-info.yaml',\n  );\n  console.log((await response.buffer()).toString());\n  // ...\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["This will be run every time you restart the backend. Note that after any change\nin the URL Reader code, you need to stop the backend and restart, since the\n",(0,t.jsx)(n.code,{children:"reader"})," instance is memoized and does not update on hot module reloading. Also,\nthere are a lot of unit tests written for the URL Readers, which you can make\nuse of."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},221020:(e,n,a)=>{var t=a(296540),r=Symbol.for("react.element"),s=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,c=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,o={key:!0,ref:!0,__self:!0,__source:!0};function d(e,n,a){var t,s={},d=null,l=null;for(t in void 0!==a&&(d=""+a),void 0!==n.key&&(d=""+n.key),void 0!==n.ref&&(l=n.ref),n)i.call(n,t)&&!o.hasOwnProperty(t)&&(s[t]=n[t]);if(e&&e.defaultProps)for(t in n=e.defaultProps)void 0===s[t]&&(s[t]=n[t]);return{$$typeof:r,type:e,key:d,ref:l,props:s,_owner:c.current}}n.Fragment=s,n.jsx=d,n.jsxs=d},474848:(e,n,a)=>{e.exports=a(221020)},28453:(e,n,a)=>{a.d(n,{R:()=>i,x:()=>c});var t=a(296540);const r={},s=t.createContext(r);function i(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);